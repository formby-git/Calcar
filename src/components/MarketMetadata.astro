---

---

<div id="market-metadata-card" class="mt-8 pt-8 hidden">
    <div class="flex items-center gap-3 mb-4">
        <div>
            <h4
                class="text-sm font-grotesk font-bold uppercase tracking-widest text-swiss-black mb-1 flex items-center gap-2"
            >
                <div class="w-3 h-3 bg-swiss-blue"></div>
                Depreciation Accuracy Check
            </h4>
            <p class="text-sm font-sans tracking-tight text-swiss-black">
                Verifying slope against 2022 Market Data
            </p>
        </div>
    </div>

    <div id="market-data-content" class="space-y-4">
        <!-- JS will populate this -->
    </div>

    <div
        id="market-data-missing"
        <div
        id="market-data-missing"
        class="hidden text-sm font-sans text-swiss-black"
    >
        > Insufficient historical data to verify the depreciation curve for this
        specific car.
    </div>
</div>

<script>
    /**
     * ================================================================================
     * DEPRECIATION ACCURACY CHECK - MarketMetadata.astro
     * ================================================================================
     *
     * PURPOSE:
     * This component validates our depreciation calculator against real 2022 market data.
     * It acts as a "lab test" to show users whether our predictions are accurate for
     * cars of their car's current age.
     *
     * ================================================================================
     * KEY CONCEPT: FORWARD-LOOKING COMPARISON
     * ================================================================================
     *
     * The goal is to test the depreciation the user is ABOUT TO EXPERIENCE over their
     * entire selected ownership term.
     *
     * Example: User has a 2018 car. Today is 2026. The car is 8 years old.
     * They select a 3-year ownership term.
     *
     *   WRONG APPROACH (Testing the past):
     *   - Test Year 5 → 8 transition.
     *   - This tells us nothing about an 8-year-old car!
     *
     *   CORRECT APPROACH (Testing the future):
     *   - Car is 8 years old now. After 3 years of ownership, it will be 11.
     *   - Find cars that were 8 and 11 years old in 2022 (2014 & 2011 models).
     *   - Test Year 8 → 11 transition.
     *   - This validates the exact curve segment the user is about to ride.
     *
     * ================================================================================
     */

    import type { Car } from "../utils/carService";
    import { calculateResidualFactor } from "../utils/depreciationCalculator";
    import marketStats from "../data/market_stats.json";

    const card = document.getElementById("market-metadata-card");
    const content = document.getElementById("market-data-content");
    const missing = document.getElementById("market-data-missing");

    const SNAPSHOT_YEAR = 2022; // Year when market_stats.json data was collected
    const CURRENT_YEAR = new Date().getFullYear();

    let currentCar: Car | null = null;
    let currentTermYears: number = 3;

    function updateAudit() {
        if (!card || !content || !missing || !currentCar) return;

        const car = currentCar;

        // --- 1. FIND CAR DATA (Exact Match) ---
        const makeKey = car.make.toLowerCase().trim();
        const modelKey = car.model.toLowerCase().trim();

        const modelData = (marketStats as any)[makeKey]?.[modelKey];
        if (!modelData) {
            card.classList.remove("hidden");
            content.classList.add("hidden");
            missing.classList.remove("hidden");
            return;
        }

        // --- 2. FUEL MAPPING ---
        const carFuel = car.fuelType.toLowerCase();
        let fuelKeysToTry = [carFuel];
        if (carFuel.includes("hybrid")) {
            fuelKeysToTry = [
                "petrol hybrid",
                "petrol plug-in hybrid",
                "diesel hybrid",
                "hybrid",
            ];
        }

        let statForFuel: any = null;
        for (const f of fuelKeysToTry) {
            if (modelData[f]) {
                statForFuel = modelData[f];
                break;
            }
        }

        if (!statForFuel) {
            card.classList.remove("hidden");
            content.classList.add("hidden");
            missing.classList.remove("hidden");
            return;
        }

        // --- 3. FIND EQUIVALENT-AGED CAR FROM 2022 (Forward-Looking) ---
        const currentCarAge = CURRENT_YEAR - car.yearOfManufacture;

        // Find historical cars matching current age → current age + term
        const termYears = currentTermYears;
        const historicalNewerYear = SNAPSHOT_YEAR - currentCarAge; // e.g., 2014
        const historicalOlderYear = historicalNewerYear - termYears; // e.g., 2011

        const statNewer = statForFuel[historicalNewerYear.toString()];
        const statOlder = statForFuel[historicalOlderYear.toString()];

        // Validate (Min 3 samples)
        const MIN_SAMPLES = 3;
        const isValid =
            statOlder &&
            statNewer &&
            statOlder.count >= MIN_SAMPLES &&
            statNewer.count >= MIN_SAMPLES;

        if (!isValid) {
            card.classList.remove("hidden");
            content.classList.add("hidden");
            missing.classList.remove("hidden");
            return;
        }

        // --- 4. CALCULATE DROPS ---
        // Market drop: Year currentCarAge → (currentCarAge + termYears)
        const priceOlder = statOlder.avgPrice;
        const priceNewer = statNewer.avgPrice;
        const marketDropRate = (priceNewer - priceOlder) / priceNewer;

        // Model drop for the same age transition
        const ageNewer = currentCarAge;
        const ageOlder = currentCarAge + termYears;

        // Edge case: If car hasn't been made yet, we can't compare
        if (currentCarAge < 0) {
            card.classList.remove("hidden");
            content.classList.add("hidden");
            missing.classList.remove("hidden");
            return;
        }

        const factorNewer = calculateResidualFactor(car, ageNewer);
        const factorOlder = calculateResidualFactor(car, ageOlder);

        const modelDropRate = (factorNewer - factorOlder) / factorNewer;

        // --- 5. RENDER ---
        const diffRate = marketDropRate - modelDropRate;
        const diffPercent = diffRate * 100;
        const toPercent = (n: number) => (n * 100).toFixed(1) + "%";

        const isPessimistic = modelDropRate > marketDropRate;
        const statusLabel =
            Math.abs(diffPercent) < 2
                ? "MATCH"
                : isPessimistic
                  ? "PESSIMISTIC"
                  : "OPTIMISTIC";
        const statusColor =
            Math.abs(diffPercent) < 2
                ? "bg-green-600 text-white"
                : isPessimistic
                  ? "bg-swiss-black text-white"
                  : "bg-orange-500 text-white";

        content.innerHTML = `
            <div class="border border-gray-200 p-6 bg-swiss-white font-sans text-sm relative">
                <!-- Receipt Jagged Edge Top (CSS Trick or SVG) -->
                
                <div class="text-center border-b border-dashed border-gray-200 pb-4 mb-4">
                    <h5 class="text-xl font-bold uppercase tracking-widest text-swiss-black">Market Audit</h5>
                    <p class="text-sm text-swiss-black mt-1">Ref: ${new Date().getFullYear()}-AUDIT-${car.make.substring(0, 3).toUpperCase()}</p>
                </div>

                <div class="grid grid-cols-2 gap-8 mb-6">
                    <!-- Market Data -->
                    <div>
                        <h5 class="text-sm font-bold uppercase tracking-widest text-swiss-black mb-1">Reality (2022)</h5>
                        <p class="text-xl font-bold text-swiss-black">${toPercent(marketDropRate)} <span class="text-base font-normal">DROP</span></p>
                        <p class="text-sm text-swiss-black mt-1 leading-tight">
                            Samples: ${statNewer.count + statOlder.count}<br>
                            Models: ${historicalNewerYear} > ${historicalOlderYear}
                        </p>
                    </div>
                    
                    <!-- Our Model -->
                    <div class="text-right">
                        <h5 class="text-sm font-bold uppercase tracking-widest text-swiss-black mb-1">Projection</h5>
                         <p class="text-xl font-bold text-swiss-black">${toPercent(modelDropRate)} <span class="text-base font-normal">DROP</span></p>
                        <p class="text-sm text-swiss-black mt-1 leading-tight">
                            Year ${ageNewer} > ${ageOlder}<br>
                            Simulated (${termYears}Y Term)
                        </p>
                    </div>
                </div>

                <div class="border-t border-dashed border-gray-200 pt-4 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                         <span class="px-3 py-1 text-sm font-bold tracking-widest ${statusColor} uppercase">
                            ${statusLabel}
                        </span>
                    </div>
                    <div class="text-right">
                        <p class="text-sm uppercase tracking-widest text-swiss-black mb-0.5">Delta</p>
                        <p class="font-bold text-lg ${Math.abs(diffPercent) < 2 ? "text-green-600" : "text-swiss-black"}">
                            ${diffPercent > 0 ? "+" : ""}${diffPercent.toFixed(1)}%
                        </p>
                    </div>
                </div>
            </div>
            
        `;

        card.classList.remove("hidden");
        content.classList.remove("hidden");
        missing.classList.add("hidden");
    }

    window.addEventListener("car-loaded", ((e: CustomEvent<Car>) => {
        currentCar = e.detail;
        updateAudit();
    }) as unknown as EventListener);

    window.addEventListener("calculator-updated", ((e: CustomEvent<any>) => {
        const newTermYears = Math.ceil(e.detail.termMonths / 12);
        if (currentTermYears !== newTermYears) {
            currentTermYears = newTermYears;
            updateAudit();
        }
    }) as unknown as EventListener);
</script>
