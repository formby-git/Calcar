---
import Layout from "../layouts/Layout.astro";
import RegistrationForm from "../components/RegistrationForm.astro";
import cars from "../data/cars.json";

const allFeaturedCars = cars.map((c) => ({
	model: `${c.make} ${c.model}`,
	reg: c.registration,
}));
---

<Layout title="Calcar - Smart Car Ownership">
	<div
		id="landing-background"
		class="fixed inset-0 z-[-1] transition-opacity duration-700 bg-[linear-gradient(to_right,#f0f0f0_1px,transparent_1px),linear-gradient(to_bottom,#f0f0f0_1px,transparent_1px)] bg-[size:4rem_4rem]"
	>
	</div>

	<div
		id="landing-wrapper"
		class="min-h-[80vh] flex flex-col justify-center transition-all duration-700 ease-in-out"
		data-state="initial"
		data-featured-cars={JSON.stringify(allFeaturedCars)}
	>
		<div
			id="hero-content"
			class="mb-16 text-center transition-all duration-500 delay-100 px-4"
		>
			<h1
				class="text-4xl md:text-6xl font-bold tracking-tighter mb-8 text-swiss-black leading-[1.1] max-w-4xl mx-auto"
			>
				Find out the true cost of owning a
				<span
					id="hero-car-model"
					class="text-swiss-blue inline-block transition-opacity duration-300 min-w-[200px]"
					>Volkswagen Golf</span
				>
				over
				<span
					id="hero-term"
					class="text-swiss-blue inline-block transition-opacity duration-300 min-w-[50px]"
					>3</span
				>
				years
			</h1>
		</div>

		<div
			class="w-full max-w-xl mx-auto transition-transform duration-700 px-4"
		>
			<RegistrationForm />
		</div>
	</div>
</Layout>

<script>
	const wrapper = document.getElementById("landing-wrapper");
	const background = document.getElementById("landing-background");
	const resultsContainer = document.getElementById("results-container");
	const heroContent = document.getElementById("hero-content");

	// Landing Page Animation Logic
	const heroModel = document.getElementById("hero-car-model");
	const heroTerm = document.getElementById("hero-term");
	const regInput = document.getElementById("reg-input") as HTMLInputElement;

	// Load cars from data attribute
	let featuredCars: { model: string; reg: string }[] = [];
	try {
		const data = wrapper?.dataset.featuredCars;
		if (data) {
			featuredCars = JSON.parse(data);
		}
	} catch (e) {
		console.error("Failed to parse featured cars", e);
	}

	// Fallback if parsing fails (though it shouldn't)
	if (featuredCars.length === 0) {
		featuredCars = [
			{ model: "Nissan Qashqai", reg: "EF70 QRS" },
			{ model: "Vauxhall Corsa", reg: "GH15 TUV" },
			{ model: "Land Rover Discovery Sport", reg: "OP67 RST" },
		];
	}

	const ownershipTerms = [1, 2, 3, 4, 5];

	// Shuffle array for randomness
	for (let i = featuredCars.length - 1; i > 0; i--) {
		const j = Math.floor(Math.random() * (i + 1));
		[featuredCars[i], featuredCars[j]] = [featuredCars[j], featuredCars[i]];
	}

	let currentIndex = 0;

	// Initial set (if input is empty)
	if (regInput && !regInput.value) {
		regInput.value = featuredCars[0].reg;
	}

	const cycleHero = () => {
		// Only cycle if user hasn't interacted with the input (optional check, but safer to just cycle as requested)
		// The prompt implies it should just cycle: "swap it out every 3 seconds as well"
		// To avoid annoying the user if they are typing, we could check focus, but the prompt says user can "just tap Analyse", implying they wait for a suggestion.
		// Let's check focus to be polite, or just do it. I'll check focus.
		if (document.activeElement === regInput) return;

		currentIndex = (currentIndex + 1) % featuredCars.length;
		const nextCar = featuredCars[currentIndex];
		const nextTerm =
			ownershipTerms[Math.floor(Math.random() * ownershipTerms.length)];

		// Animate Out
		if (heroModel) heroModel.style.opacity = "0";
		if (heroTerm) heroTerm.style.opacity = "0";
		if (regInput) regInput.style.opacity = "0.5";

		setTimeout(() => {
			// Update
			if (heroModel) heroModel.textContent = nextCar.model;
			if (heroTerm) heroTerm.textContent = nextTerm.toString();
			if (regInput) regInput.value = nextCar.reg;

			// Animate In
			if (heroModel) heroModel.style.opacity = "1";
			if (heroTerm) heroTerm.style.opacity = "1";
			if (regInput) regInput.style.opacity = "1";
		}, 300);
	};

	const intervalId = setInterval(cycleHero, 3000);

	// Stop cycling when user interacts
	regInput?.addEventListener("focus", () => {
		clearInterval(intervalId);
		if (regInput) regInput.style.opacity = "1";
	});
</script>
